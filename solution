// Unique tab identifier
const TAB_ID = Date.now() + '_' + Math.random();
const PING_KEY = 'tab-check-ping-' + TAB_ID;
const RESPONSE_KEY = 'tab-check-response-' + TAB_ID;
const IS_PING_SENDER = true; // This tab initiated the ping

let isDuplicate = false;

// Send ping to other tabs
localStorage.setItem(PING_KEY, 'ping');

// Listen for storage events
window.addEventListener('storage', (e) => {
  // 1. Another tab pinged
  if (e.key && e.key.startsWith('tab-check-ping-')) {
    const newTabId = e.key.substring('tab-check-ping-'.length);
    const newTabResponseKey = 'tab-check-response-' + newTabId;

    if (newTabId !== TAB_ID) {
      // Alert in main tab
      alert('üö® A duplicate tab has been opened.');

      // Respond to the new (duplicate) tab
      localStorage.setItem(newTabResponseKey, 'duplicate');
    }
  }

  // 2. This tab gets a duplicate response (only if it initiated the ping)
  if (e.key === RESPONSE_KEY && e.newValue === 'duplicate') {
    if (IS_PING_SENDER && !isDuplicate) {
      isDuplicate = true;
      console.log('‚ö†Ô∏è This is a duplicate tab.');
      submitHiddenForm();
    }
  }

  // 3. Conflict notification from another duplicate tab
  if (e.key && e.key.startsWith('tab-conflict-')) {
    const dupTabId = e.key.substring('tab-conflict-'.length);

    if (dupTabId !== TAB_ID) {
      alert('‚ö†Ô∏è A duplicate tab caused a conflict (409). You may want to close that tab.');
    }
  }
});

// Confirm role after delay
setTimeout(() => {
  if (!isDuplicate) {
    console.log('‚úÖ This is the main tab.');
  }

  // Cleanup to avoid stale triggers
  localStorage.removeItem(PING_KEY);
  localStorage.removeItem(RESPONSE_KEY);
}, 300);

// Simulate 409 conflict on page load for duplicate
window.addEventListener('load', () => {
  if (isDuplicate) {
    setTimeout(() => {
      console.warn('‚ö†Ô∏è Simulating 409 conflict due to duplicate tab.');
      const conflictKey = 'tab-conflict-' + TAB_ID;
      localStorage.setItem(conflictKey, '409');
    }, 1000);
  }
});

// Hidden form submission logic
function submitHiddenForm() {
  const form = document.createElement('form');
  form.style.display = 'none';
  form.method = 'POST';
  form.action = '/submit-duplicate'; // Replace with your real endpoint
  document.body.appendChild(form);
  form.submit();
}
